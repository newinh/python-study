
# 파이선의 고수준 동시성

### 동시성


프로세스기반 동시성(multiprocessing)은 별개의 프로세스를 서로 독립적으로 실행하는 경우를 의미한다.


일반적으로 동시 프로세스는 IPC를 활용해 공유 데이터에 접근한다. (공유메모리를 활용할 수도 있다.)
다른 정류의 동시성은 동시실행대신 "동시 대기(concurrent waiting)"를 기반으로 한 것이다.


>IPC(Inter-Process Communication)

저수준 비동기 I/O : asyncore, asychat 모듈
고수준 : 트위스티드 프레임워크(외부), 3.4부터는 표준 라이브러리에 추가될 예정

####GIL(Global Interpreter Lock)


- CPU 위주의 프로그램 - 다중프로세스 활용 권장
CPU를 쉬지않고 바쁘게 사용하는 프로그램

- I/O 위주의 프로그램 - 스레드를 활용 권장
중간중간 대기하는 작업이 필요한 프로그램

### 동시성 수준을 세가지로 정의

- **저수준** : 원자적 연산(atomic operation)을 명시적으로 사용하는 경우다. 라이브러리가 해줌
- **중간수준** : 명시적 락을 사용하는 경우.
- 고수준 : 원자적 연산이나 락을 명시적으로 활용하지 않는 경우다.(아랫단에서는 원자적 연산이나 락을 활용할 수도 있겠지만 프로그래머가 이를 신경 쓸 필요는 없다.)



##### 데이터 공유가 가장 큰 문제.

변경가능한 공유 데이터에 대한 접근 직렬화(즉, 한 번에 한 스레드나 프로세스만 공유 데이터에 접근함)를 보장하기 위해서는 반드시 락을 사용해 대상 데이터를 보호해야한다. 락을 사용하려면 가능한 한 사용 빈도를 줄이고, 개별 사용시간도 최소화해야한다. 가장 간단한 해법은 변경가능한 데이터를 아예 공유하지 않는것이다.


- 변경 불가능한 데이터를 전달하거나 읽기용 자료구조를 전달
- 깊은 복사(deep copy)
- 다중 프로세스의 경우, 동시 접근을 지원하는 자료구조를 활용한다.


### 큐를 활용
queue모듈은 몇가지 스레드 안전한 큐를 제공한다. -> 락 처리를 자료구조자체에서 수행


작업 프로세스는 무한루프를 돌면서 공유 작업 큐에서 작업을 가져온다.

> multiprocessing.cpu_count()


### 퓨처와 다중 프로세스의 활용
concurrent.futures.Future는 "호출 가능한 객체의 비동기적 실행"을 담아두는 객체다. 퓨체는 concurrent.futures.Executor.submit() 메서드를 호출해서 만들 수 있으며, 자신의 상태를 보고하거나 실행결과 또는 예외를 반환할 수 있다.




저수준 프로토콜을 활용해 네트워크 통신을 하는 것은 전달하고자 하는 모든 데이터 조각을 직접 엮어서 전송하고, 다시 반대쪽에서 받아 데이터를 푼 다음, 전송받은 데이터에 맞는 연산을 수행해야 한다는 의미다.








